
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>authenticator: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">kroseida.org/slixx/internal/master/authenticator/kind.go (100.0%)</option>
				
				<option value="file1">kroseida.org/slixx/internal/master/authenticator/password.go (85.7%)</option>
				
				<option value="file2">kroseida.org/slixx/internal/master/datasource/connector.go (76.7%)</option>
				
				<option value="file3">kroseida.org/slixx/internal/master/datasource/migration/script.go (87.5%)</option>
				
				<option value="file4">kroseida.org/slixx/internal/master/datasource/migration/v1__initialize.go (71.4%)</option>
				
				<option value="file5">kroseida.org/slixx/internal/master/datasource/migration/v2__storage.go (80.0%)</option>
				
				<option value="file6">kroseida.org/slixx/internal/master/datasource/provider/helper.go (84.0%)</option>
				
				<option value="file7">kroseida.org/slixx/internal/master/datasource/provider/storage.go (72.4%)</option>
				
				<option value="file8">kroseida.org/slixx/internal/master/datasource/provider/user.go (75.9%)</option>
				
				<option value="file9">kroseida.org/slixx/internal/master/graphql/controller/storage.go (74.6%)</option>
				
				<option value="file10">kroseida.org/slixx/internal/master/graphql/controller/user.go (68.3%)</option>
				
				<option value="file11">kroseida.org/slixx/internal/master/graphql/controller/utils.go (72.7%)</option>
				
				<option value="file12">kroseida.org/slixx/pkg/dto/mapper.go (66.7%)</option>
				
				<option value="file13">kroseida.org/slixx/pkg/model/user.go (79.5%)</option>
				
				<option value="file14">kroseida.org/slixx/pkg/utils/file.go (100.0%)</option>
				
				<option value="file15">kroseida.org/slixx/pkg/utils/generator.go (75.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package authenticator

import (
        "kroseida.org/slixx/pkg/model"
)

type Kind interface {
        Validate(authentication *model.Authentication, request string) (bool, error)
        ParseConfiguration(configurationJson string) (any, error)
}

var PASSWORD = "password"

var kinds = map[string]Kind{
        PASSWORD: Password{},
}

func GetKind(kind string) Kind <span class="cov8" title="1">{
        return kinds[kind]
}</span>
</pre>
		
		<pre class="file" id="file1" style="display: none">package authenticator

import (
        "encoding/json"
        "github.com/samsarahq/thunder/graphql"
        "golang.org/x/crypto/bcrypt"
        "kroseida.org/slixx/internal/master/application"
        "kroseida.org/slixx/pkg/model"
)

type Password struct {
}

type PasswordConfiguration struct {
        Name string
        Hash string
}

type PasswordRequestContainer struct {
        Name     string
        Password string
}

func (kind Password) Validate(authentication *model.Authentication, sendConfigurationJson string) (bool, error) <span class="cov8" title="1">{
        sendConfiguration, err := kind.ParseRequestContainer(sendConfigurationJson)
        if err != nil </span><span class="cov0" title="0">{
                return false, err
        }</span>

        <span class="cov8" title="1">configurationRaw, err := kind.ParseConfiguration(authentication.Configuration)
        if err != nil </span><span class="cov0" title="0">{
                return false, err
        }</span>

        <span class="cov8" title="1">var configuration = configurationRaw.(*PasswordConfiguration)

        if configuration.Name != sendConfiguration.Name </span><span class="cov8" title="1">{
                return false, nil
        }</span>

        <span class="cov8" title="1">err = bcrypt.CompareHashAndPassword([]byte(configuration.Hash), []byte(sendConfiguration.Password))

        if err != nil </span><span class="cov8" title="1">{
                return false, err
        }</span>

        <span class="cov8" title="1">return true, nil</span>
}

func (Password) ParseRequestContainer(configurationJson string) (*PasswordRequestContainer, error) <span class="cov8" title="1">{
        var container PasswordRequestContainer
        err := json.Unmarshal([]byte(configurationJson), &amp;container)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">if container.Name == "" </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("name is required")
        }</span>
        <span class="cov8" title="1">if container.Password == "" </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("password is required")
        }</span>

        <span class="cov8" title="1">return &amp;container, nil</span>
}

func (Password) ParseConfiguration(configurationJson string) (any, error) <span class="cov8" title="1">{
        var configuration PasswordConfiguration
        err := json.Unmarshal([]byte(configurationJson), &amp;configuration)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">if configuration.Name == "" </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("name is required")
        }</span>
        <span class="cov8" title="1">if configuration.Hash == "" </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("hash is required")
        }</span>

        <span class="cov8" title="1">return &amp;configuration, nil</span>
}

func (Password) GenerateConfigurationFromRequestContainer(configuration *PasswordRequestContainer) (*PasswordConfiguration, error) <span class="cov8" title="1">{
        hash, err := bcrypt.GenerateFromPassword([]byte(configuration.Password), application.CurrentSettings.Authentication.HashCost)

        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">return &amp;PasswordConfiguration{
                configuration.Name,
                string(hash),
        }, nil</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package datasource

import (
        "gorm.io/driver/sqlite"
        "gorm.io/gorm"
        "gorm.io/gorm/logger"
        "kroseida.org/slixx/internal/master/application"
        "kroseida.org/slixx/internal/master/datasource/migration"
        "kroseida.org/slixx/internal/master/datasource/provider"
)

var StorageProvider provider.StorageProvider
var UserProvider provider.UserProvider
var localDatabase *gorm.DB

func Connect() error <span class="cov8" title="1">{
        var err error
        if application.CurrentSettings.Database.Kind == "sqlite" </span><span class="cov8" title="1">{
                err = ConnectSqlite()
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">err = migration.Migrate(localDatabase)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">StorageProvider = provider.StorageProvider{Database: localDatabase}
        UserProvider = provider.UserProvider{Database: localDatabase}
        err = UserProvider.Init()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">return nil</span>
}

func ConnectSqlite() error <span class="cov8" title="1">{
        var logMode logger.LogLevel
        if application.CurrentSettings.Logger.Mode == "debug" </span><span class="cov0" title="0">{
                logMode = logger.Info
        }</span> else<span class="cov8" title="1"> {
                logMode = logger.Silent
        }</span>

        <span class="cov8" title="1">database, err := gorm.Open(sqlite.Open(application.CurrentSettings.Database.Configuration["file"]), &amp;gorm.Config{
                DisableForeignKeyConstraintWhenMigrating: true,
                Logger:                                   logger.Default.LogMode(logMode),
        })
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov8" title="1">localDatabase = database
        return nil</span>
}

func Close() error <span class="cov8" title="1">{
        sqlDb, err := localDatabase.DB()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov8" title="1">err = sqlDb.Close()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov8" title="1">return nil</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package migration

import (
        "github.com/google/uuid"
        "gorm.io/gorm"
        "kroseida.org/slixx/internal/master/application"
        "kroseida.org/slixx/pkg/model"
)

type Script interface {
        GetName() string
        Migrate(db *gorm.DB) error
}

var migrationScripts = []Script{
        V1Initialize{},
        V2Storage{},
}

func Migrate(database *gorm.DB) error <span class="cov8" title="1">{
        return MigrateScripts(database, migrationScripts)
}</span>

func MigrateScripts(database *gorm.DB, scripts []Script) error <span class="cov8" title="1">{
        if (!database.Migrator().HasTable(&amp;model.Migration{})) </span><span class="cov8" title="1">{
                database.Migrator().CreateTable(&amp;model.Migration{})
        }</span>
        <span class="cov8" title="1">for migration := range scripts </span><span class="cov8" title="1">{
                err := database.Transaction(func(context *gorm.DB) error </span><span class="cov8" title="1">{
                        targetMigration := scripts[migration]

                        // Check if migration is already applied
                        var existingMigration model.Migration
                        context.First(&amp;existingMigration, "name = ?", targetMigration.GetName())
                        if existingMigration != (model.Migration{}) </span><span class="cov0" title="0">{
                                return nil
                        }</span>

                        <span class="cov8" title="1">application.Logger.Info("Migrating: " + scripts[migration].GetName())
                        context.Create(&amp;model.Migration{
                                Id:   uuid.New(),
                                Name: targetMigration.GetName(),
                        })
                        return targetMigration.Migrate(context)</span>
                })
                <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                        return err
                }</span>
        }
        <span class="cov8" title="1">return nil</span>
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package migration

import (
        "gorm.io/gorm"
)

type V1Initialize struct {
}

func (V1Initialize) GetName() string <span class="cov8" title="1">{
        return "v1__initialize"
}</span>

func (V1Initialize) Migrate(database *gorm.DB) error <span class="cov8" title="1">{
        err := database.Exec(`CREATE TABLE users (id char(36) NOT NULL,
                                                                                                   name text NOT NULL,
                                                                                                   email text NOT NULL,
                                                                                                   first_name text NOT NULL,
                                                                                                   last_name text NOT NULL,
                                                                                                   active boolean NOT NULL,
                                                                                                   permissions text NOT NULL,
                                                                                                   description text NOT NULL,
                                                                                                   created_at DATETIME, 
                                                                                                   updated_at DATETIME, 
                                                                                                   deleted_at DATETIME, 
                                                                                                   PRIMARY KEY (id)
                                                                                    )`).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">err = database.Exec(`CREATE TABLE authentications (id char(36) NOT NULL, 
                                                                                                                   kind text NOT NULL, 
                                                                                                                   configuration text NOT NULL, 
                                                                                                                   user_id char(36) NOT NULL, 
                                                                                                                   created_at DATETIME, 
                                                                                                                   updated_at DATETIME, 
                                                                                                                   deleted_at DATETIME, 
                                                                                                                   PRIMARY KEY (id),
                                                                                                                   FOREIGN KEY (user_id) REFERENCES users(id)
                                                                                       )`).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">err = database.Exec(`CREATE TABLE sessions (id char(36) NOT NULL,
                                                                                                        token text NOT NULL,
                                                                                                         user_id char(36) NOT NULL,
                                                                                                         expires_at DATETIME NOT NULL,
                                                                                                         created_at DATETIME,
                                                                                                         updated_at DATETIME,
                                                                                                         deleted_at DATETIME,
                                                                                                         PRIMARY KEY (id),
                                                                                                         FOREIGN KEY (user_id) REFERENCES users(id)
                                                                        )`).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">err = database.Exec(`CREATE TABLE storages (id char(36) NOT NULL, 
                                                    name text NOT NULL, 
                                                    kind text NOT NULL,
                                                    configuration text NOT NULL,
                                                    created_at DATETIME, 
                                                    updated_at DATETIME, 
                                                    deleted_at DATETIME,
                                                    PRIMARY KEY (id)
                                                   )`).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">return nil</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package migration

import (
        "gorm.io/gorm"
)

type V2Storage struct {
}

func (V2Storage) GetName() string <span class="cov8" title="1">{
        return "v2__storage"
}</span>

func (V2Storage) Migrate(database *gorm.DB) error <span class="cov8" title="1">{
        err := database.Exec(`ALTER TABLE storages ADD description TEXT`).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">return nil</span>
}
</pre>
		
		<pre class="file" id="file6" style="display: none">package provider

import (
        "gorm.io/gorm"
        "math"
        "regexp"
        "strings"
)

var matchFirstCap = regexp.MustCompile("(.)([A-Z][a-z]+)")
var matchAllCap = regexp.MustCompile("([a-z0-9])([A-Z])")

func isSqlError(err error) bool <span class="cov8" title="1">{
        if err == nil </span><span class="cov8" title="1">{
                return false
        }</span>
        <span class="cov8" title="1">if err == gorm.ErrRecordNotFound </span><span class="cov8" title="1">{
                return false
        }</span>
        <span class="cov0" title="0">return true</span>
}

type Pagination[T any] struct {
        Limit      int    `json:"limit,omitempty;query:limit"`
        Page       int    `json:"page,omitempty;query:page"`
        Sort       string `json:"sort,omitempty;query:sort"`
        TotalRows  int64  `json:"totalRows"`
        TotalPages int    `json:"totalPages"`
        Rows       []T    `json:"rows"`
        Search     string `json:"search"`
}

func (p *Pagination[any]) GetOffset() int <span class="cov8" title="1">{
        return (p.GetPage() - 1) * p.GetLimit()
}</span>

func (p *Pagination[any]) GetLimit() int <span class="cov8" title="1">{
        if p.Limit == 0 </span><span class="cov0" title="0">{
                p.Limit = 20
        }</span>
        <span class="cov8" title="1">if p.Limit &gt; 200 </span><span class="cov0" title="0">{
                p.Limit = 20
        }</span>
        <span class="cov8" title="1">return p.Limit</span>
}

func (p *Pagination[any]) GetPage() int <span class="cov8" title="1">{
        if p.Page == 0 </span><span class="cov0" title="0">{
                p.Page = 1
        }</span>
        <span class="cov8" title="1">return p.Page</span>
}

func (p *Pagination[any]) GetSort() string <span class="cov8" title="1">{
        if p.Sort == "" </span><span class="cov8" title="1">{
                p.Sort = "created_at asc"
        }</span>
        <span class="cov8" title="1">return p.toSnakeCase(p.Sort)</span>
}

func (p *Pagination[any]) toSnakeCase(str string) string <span class="cov8" title="1">{
        snake := matchFirstCap.ReplaceAllString(str, "${1}_${2}")
        snake = matchAllCap.ReplaceAllString(snake, "${1}_${2}")
        return strings.ToLower(snake)
}</span>

func paginate[T any](value T, searchField string, pagination *Pagination[T], db *gorm.DB) *gorm.DB <span class="cov8" title="1">{
        var totalRows int64
        db.Model(value).Where(searchField+" like ?", "%"+pagination.Search+"%").Count(&amp;totalRows)
        pagination.TotalRows = totalRows
        pagination.TotalPages = int(math.Ceil(float64(totalRows) / float64(pagination.GetLimit())))

        return db.Offset(pagination.GetOffset()).Limit(pagination.GetLimit()).Where(searchField+" like ?", "%"+pagination.Search+"%").Order(pagination.GetSort())
}</span>
</pre>
		
		<pre class="file" id="file7" style="display: none">package provider

import (
        "encoding/json"
        "github.com/google/uuid"
        "github.com/samsarahq/thunder/graphql"
        "gorm.io/gorm"
        "kroseida.org/slixx/pkg/model"
        "kroseida.org/slixx/pkg/storage"
)

// StorageProvider Storage Provider
type StorageProvider struct {
        Database *gorm.DB
}

func (provider StorageProvider) DeleteStorage(id uuid.UUID) (*model.Storage, error) <span class="cov8" title="1">{
        storage, err := provider.GetStorage(id)
        if storage == nil </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("storage not found")
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">result := provider.Database.Delete(&amp;storage)
        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return storage, nil</span>
}

func (provider StorageProvider) CreateStorage(name string, description string, kind string, configuration string) (*model.Storage, error) <span class="cov8" title="1">{
        if name == "" </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("name can not be empty")
        }</span>
        <span class="cov8" title="1">kindType := storage.ValueOf(kind)
        if kindType == nil </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("Invalid storage kind \"%s\"", kind)
        }</span>
        <span class="cov8" title="1">parsedConfiguration, err := kindType.Parse(configuration)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">rawConfiguration, err := json.Marshal(parsedConfiguration)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">configuration = string(rawConfiguration)

        if storage.ValueOf(kind) == nil </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("Invalid storage kind \"%s\"", kind)
        }</span>
        <span class="cov8" title="1">storage := model.Storage{
                Id:            uuid.New(),
                Name:          name,
                Description:   description,
                Kind:          kind,
                Configuration: configuration,
        }

        result := provider.Database.Create(&amp;storage)
        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return &amp;storage, nil</span>
}

func (provider StorageProvider) UpdateStorage(id uuid.UUID, name *string, description *string, kind *string, configuration *string) (*model.Storage, error) <span class="cov8" title="1">{
        updateStorage, err := provider.GetStorage(id)
        if updateStorage == nil </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("user not found")
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">if name != nil </span><span class="cov8" title="1">{
                if *name == "" </span><span class="cov8" title="1">{
                        return nil, graphql.NewSafeError("name can not be empty")
                }</span>
                <span class="cov8" title="1">updateStorage.Name = *name</span>
        }
        <span class="cov8" title="1">if kind != nil </span><span class="cov0" title="0">{
                kindType := storage.ValueOf(*kind)
                if kindType == nil </span><span class="cov0" title="0">{
                        return nil, graphql.NewSafeError("Invalid storage kind \"%s\"", *kind)
                }</span>
                <span class="cov0" title="0">updateStorage.Kind = *kind</span>
        }
        <span class="cov8" title="1">if configuration != nil </span><span class="cov8" title="1">{
                kindType := storage.ValueOf(updateStorage.Kind)

                parsedConfiguration, err := kindType.Parse(*configuration)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>

                <span class="cov8" title="1">rawConfiguration, err := json.Marshal(parsedConfiguration)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>

                <span class="cov8" title="1">updateStorage.Configuration = string(rawConfiguration)</span>
        }
        <span class="cov8" title="1">if description != nil </span><span class="cov0" title="0">{
                updateStorage.Description = *description
        }</span>

        <span class="cov8" title="1">result := provider.Database.Save(&amp;updateStorage)
        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return updateStorage, nil</span>
}

func (provider StorageProvider) GetStorages() ([]*model.Storage, error) <span class="cov8" title="1">{
        var storages []*model.Storage
        result := provider.Database.Find(&amp;storages)

        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return storages, nil</span>
}

func (provider StorageProvider) GetStoragesPaged(pagination *Pagination[model.Storage]) (*Pagination[model.Storage], error) <span class="cov8" title="1">{
        context := paginate(model.Storage{}, "name", pagination, provider.Database)

        var storages []model.Storage
        result := context.Find(&amp;storages)

        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">pagination.Rows = storages
        return pagination, nil</span>
}

func (provider StorageProvider) GetStorage(id uuid.UUID) (*model.Storage, error) <span class="cov8" title="1">{
        var storage *model.Storage
        result := provider.Database.First(&amp;storage, "id = ?", id)

        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>
        <span class="cov8" title="1">if result.RowsAffected == 0 </span><span class="cov0" title="0">{
                return nil, nil
        }</span>

        <span class="cov8" title="1">return storage, nil</span>
}
</pre>
		
		<pre class="file" id="file8" style="display: none">package provider

import (
        "encoding/json"
        "github.com/google/uuid"
        "github.com/samsarahq/thunder/graphql"
        "golang.org/x/crypto/bcrypt"
        "gorm.io/gorm"
        "kroseida.org/slixx/internal/master/application"
        "kroseida.org/slixx/internal/master/authenticator"
        "kroseida.org/slixx/pkg/model"
        "kroseida.org/slixx/pkg/utils"
        "strings"
        "time"
)

// UserProvider User Provider
type UserProvider struct {
        Database *gorm.DB
}

var PERMISSIONS = map[string]string{
        "user.view":              "View User",
        "user.create":            "Create User",
        "user.update":            "Update User Account",
        "user.delete":            "Delete User",
        "user.permission.update": "Update User Permissions",
        "storage.view":           "View Storage",
        "storage.create":         "Create Storage",
        "storage.update":         "Update Storage",
        "storage.delete":         "Delete Storage",
}

func (provider UserProvider) CreateUser(name string, email string, firstName string, lastName string, description string, active bool) (*model.User, error) <span class="cov8" title="1">{
        if name == "" </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("name can not be empty")
        }</span>
        <span class="cov8" title="1">if email != "" &amp;&amp; !strings.Contains(email, "@") </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("invalid email")
        }</span>
        <span class="cov8" title="1">if strings.Contains(name, " ") </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("name can not contain spaces")
        }</span>

        <span class="cov8" title="1">existingUser, err := provider.GetUserByName(name)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if existingUser != nil </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("name already in use")
        }</span>

        <span class="cov8" title="1">user := &amp;model.User{
                Id:          uuid.New(),
                Name:        name,
                FirstName:   firstName,
                LastName:    lastName,
                Email:       email,
                Description: description,
                Active:      active,
                Permissions: "[]",
        }

        result := provider.Database.Create(&amp;user)
        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return user, nil</span>
}

func (provider UserProvider) DeleteUser(id uuid.UUID) (*model.User, error) <span class="cov8" title="1">{
        user, err := provider.GetUser(id)
        if user == nil </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("user not found")
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">result := provider.Database.Delete(&amp;user)
        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return user, nil</span>
}

func (provider UserProvider) UpdateUser(id uuid.UUID, name *string, firstName *string, lastName *string, active *bool, description *string, email *string) (*model.User, error) <span class="cov8" title="1">{
        user, err := provider.GetUser(id)
        if user == nil </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("user not found")
        }</span>
        <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">if name != nil </span><span class="cov8" title="1">{
                if strings.Contains(*name, " ") </span><span class="cov0" title="0">{
                        return nil, graphql.NewSafeError("name can not contain spaces")
                }</span>
                <span class="cov8" title="1">existingUser, err := provider.GetUserByName(*name)
                if existingUser != nil </span><span class="cov0" title="0">{
                        return nil, graphql.NewSafeError("name already in use")
                }</span>
                <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov8" title="1">user.Name = *name</span>
        }
        <span class="cov8" title="1">if firstName != nil </span><span class="cov0" title="0">{
                user.FirstName = *firstName
        }</span>
        <span class="cov8" title="1">if lastName != nil </span><span class="cov0" title="0">{
                user.LastName = *lastName
        }</span>
        <span class="cov8" title="1">if active != nil </span><span class="cov0" title="0">{
                user.Active = *active
        }</span>
        <span class="cov8" title="1">if description != nil </span><span class="cov0" title="0">{
                user.Description = *description
        }</span>
        <span class="cov8" title="1">if email != nil </span><span class="cov8" title="1">{
                if *email != "" &amp;&amp; !strings.Contains(*email, "@") </span><span class="cov8" title="1">{
                        return nil, graphql.NewSafeError("invalid email")
                }</span>
                <span class="cov8" title="1">user.Email = *email</span>
        }

        <span class="cov8" title="1">result := provider.Database.Save(&amp;user)
        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return user, nil</span>
}

func (provider UserProvider) AddUserPermission(userId uuid.UUID, permissions []string) (*model.User, error) <span class="cov8" title="1">{
        user, err := provider.GetUser(userId)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if user == nil </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("user not found")
        }</span>

        <span class="cov8" title="1">user.AddPermission(permissions)

        result := provider.Database.Save(&amp;user)
        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return user, nil</span>
}

func (provider UserProvider) RemoveUserPermission(userId uuid.UUID, permissions []string) (*model.User, error) <span class="cov8" title="1">{
        user, err := provider.GetUser(userId)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if user == nil </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("user not found")
        }</span>

        <span class="cov8" title="1">user.RemovePermission(permissions)

        result := provider.Database.Save(&amp;user)
        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return user, nil</span>
}

func (provider UserProvider) GetUsers() ([]*model.User, error) <span class="cov8" title="1">{
        var users []*model.User
        result := provider.Database.Find(&amp;users)

        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return users, nil</span>
}

func (provider UserProvider) GetUsersPaged(pagination *Pagination[model.User]) (*Pagination[model.User], error) <span class="cov8" title="1">{
        context := paginate(model.User{}, "name", pagination, provider.Database)

        var users []model.User
        result := context.Find(&amp;users)

        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">pagination.Rows = users
        return pagination, nil</span>
}

func (provider UserProvider) GetUser(id uuid.UUID) (*model.User, error) <span class="cov8" title="1">{
        var user *model.User
        result := provider.Database.First(&amp;user, "id = ?", id)

        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>
        <span class="cov8" title="1">if result.RowsAffected == 0 </span><span class="cov8" title="1">{
                return nil, nil
        }</span>

        <span class="cov8" title="1">return user, nil</span>
}

func (provider UserProvider) GetUserByName(name string) (*model.User, error) <span class="cov8" title="1">{
        var user *model.User
        result := provider.Database.First(&amp;user, "name = ?", name)

        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>
        <span class="cov8" title="1">if result.RowsAffected == 0 </span><span class="cov8" title="1">{
                return nil, nil
        }</span>

        <span class="cov8" title="1">return user, nil</span>
}

func (provider UserProvider) CreateSession(userId uuid.UUID, expiresAt time.Time) (*model.Session, error) <span class="cov8" title="1">{
        user, err := provider.GetUser(userId)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if user == nil </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("user not found")
        }</span>

        <span class="cov8" title="1">session := &amp;model.Session{
                Id:        uuid.New(),
                UserId:    userId,
                ExpiresAt: expiresAt,
                Token:     utils.GenerateSecureToken(application.CurrentSettings.Authentication.TokenSize),
        }

        result := provider.Database.Create(&amp;session)
        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return session, nil</span>
}

func (provider UserProvider) GetSessions(userId uuid.UUID) ([]*model.Session, error) <span class="cov8" title="1">{
        user, err := provider.GetUser(userId)
        if err != nil </span><span class="cov0" title="0">{
                return []*model.Session{}, err
        }</span>
        <span class="cov8" title="1">if user == nil </span><span class="cov0" title="0">{
                return []*model.Session{}, graphql.NewSafeError("user not found")
        }</span>

        <span class="cov8" title="1">var sessions []*model.Session
        result := provider.Database.Find(&amp;sessions, "user_id = ? AND expires_at &gt; ?", userId, time.Now())

        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return sessions, nil</span>
}

func (provider UserProvider) GetUserBySession(token string) (uuid.UUID, error) <span class="cov8" title="1">{
        var session *model.Session
        result := provider.Database.First(&amp;session, "token = ? AND expires_at &gt; ?", token, time.Now())

        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return uuid.UUID{}, result.Error
        }</span>
        <span class="cov8" title="1">if result.RowsAffected == 0 </span><span class="cov8" title="1">{
                return uuid.UUID{}, nil
        }</span>

        <span class="cov8" title="1">return session.UserId, nil</span>
}

func (provider UserProvider) AuthenticatePassword(name string, password string) (*model.Session, error) <span class="cov8" title="1">{
        configuration, err := json.Marshal(authenticator.PasswordRequestContainer{
                Name:     name,
                Password: password,
        })
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return provider.Authenticate(authenticator.PASSWORD, string(configuration))</span>
}

func (provider UserProvider) Authenticate(kindName string, configuration string) (*model.Session, error) <span class="cov8" title="1">{
        kind := authenticator.GetKind(kindName)
        if kind == nil </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("invalid authentication kind")
        }</span>

        <span class="cov8" title="1">var authentications []*model.Authentication
        result := provider.Database.Find(&amp;authentications, "kind = ?", kindName)

        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>
        <span class="cov8" title="1">if result.RowsAffected == 0 </span><span class="cov0" title="0">{
                return nil, nil
        }</span>

        <span class="cov8" title="1">hasBcryptError := false

        var targetAuthentication *model.Authentication
        for _, authentication := range authentications </span><span class="cov8" title="1">{
                isValid, err := kind.Validate(authentication, configuration)
                if err != nil </span><span class="cov8" title="1">{
                        if err == bcrypt.ErrMismatchedHashAndPassword </span><span class="cov8" title="1">{
                                hasBcryptError = true
                        }</span>
                        <span class="cov8" title="1">continue</span>
                }
                <span class="cov8" title="1">if isValid </span><span class="cov8" title="1">{
                        targetAuthentication = authentication
                        break</span>
                }
        }
        <span class="cov8" title="1">if targetAuthentication == nil </span><span class="cov8" title="1">{
                if !hasBcryptError </span><span class="cov8" title="1">{
                        // we don't want to leak information about the existence of a user with the given name over timing attacks
                        // (auth with name a: took 500ms -&gt; user does not exist, because system did not ran into bcrypt hash)
                        // so we delay the response based on the bcrypt hashing duration.
                        // (todo: make this configurable and improve for more security)
                        bcrypt.GenerateFromPassword([]byte(utils.GenerateSecureToken(16)), application.CurrentSettings.Authentication.HashCost)
                }</span>
                <span class="cov8" title="1">return nil, graphql.NewSafeError("authentication failed")</span>
        }

        <span class="cov8" title="1">return provider.CreateSession(targetAuthentication.UserId, time.Now().Add(time.Hour*time.Duration(application.CurrentSettings.Authentication.SessionDuration)))</span>
}

func (provider UserProvider) CreatePasswordAuthentication(userId uuid.UUID, password string) (*model.Authentication, error) <span class="cov8" title="1">{
        user, err := provider.GetUser(userId)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if user == nil </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("user not found")
        }</span>
        <span class="cov8" title="1">kind := authenticator.GetKind(authenticator.PASSWORD).(authenticator.Password)

        configuration, err := kind.GenerateConfigurationFromRequestContainer(&amp;authenticator.PasswordRequestContainer{
                Name:     user.Name,
                Password: password,
        })
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">configurationJson, err := json.Marshal(configuration)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">var authentication *model.Authentication
        result := provider.Database.Delete(&amp;authentication, "kind = ? AND user_id = ?", authenticator.PASSWORD, userId)
        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return provider.CreateAuthentication(userId, authenticator.PASSWORD, string(configurationJson))</span>
}

func (provider UserProvider) CreateAuthentication(userId uuid.UUID, kind string, configuration string) (*model.Authentication, error) <span class="cov8" title="1">{
        user, err := provider.GetUser(userId)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if user == nil </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("user not found")
        }</span>

        <span class="cov8" title="1">err = json.Unmarshal([]byte(configuration), &amp;struct{}{})
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">authentication := &amp;model.Authentication{
                Id:            uuid.New(),
                Kind:          kind,
                Configuration: configuration,
                UserId:        userId,
        }

        _, err = authenticator.GetKind(kind).ParseConfiguration(configuration)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">result := provider.Database.Create(&amp;authentication)
        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>

        <span class="cov8" title="1">return authentication, nil</span>
}

func (provider UserProvider) Init() error <span class="cov8" title="1">{
        // Create default user if migration did not create one
        err := provider.defaultUserMigration()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">return nil</span>
}

func (provider UserProvider) defaultUserMigration() error <span class="cov8" title="1">{
        var migration *model.Migration
        result := provider.Database.First(&amp;migration, "name = ?", "default_user")
        if isSqlError(result.Error) </span><span class="cov0" title="0">{
                return result.Error
        }</span>
        <span class="cov8" title="1">if result.RowsAffected != 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov8" title="1">user, err := provider.CreateUser("admin", "", "", "", "default admin user", true)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov8" title="1">permissions := make([]string, 0)

        for permission := range PERMISSIONS </span><span class="cov8" title="1">{
                permissions = append(permissions, permission)
        }</span>

        <span class="cov8" title="1">_, err = provider.AddUserPermission(user.Id, permissions)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">_, err = provider.CreatePasswordAuthentication(user.Id, "admin")
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">err = provider.Database.Create(&amp;model.Migration{
                Id:   uuid.New(),
                Name: "default_user",
        }).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">return nil</span>
}
</pre>
		
		<pre class="file" id="file9" style="display: none">package controller

import (
        "context"
        "github.com/google/uuid"
        "github.com/samsarahq/thunder/graphql"
        "github.com/samsarahq/thunder/reactive"
        "kroseida.org/slixx/internal/master/application"
        "kroseida.org/slixx/internal/master/datasource"
        "kroseida.org/slixx/internal/master/datasource/provider"
        "kroseida.org/slixx/pkg/dto"
        "kroseida.org/slixx/pkg/model"
        "kroseida.org/slixx/pkg/storage"
        "reflect"
        "time"
)

type Storage struct {
        Id            uuid.UUID `json:"id" graphql:"id"`
        Name          string    `json:"name" graphql:"name"`
        Description   string    `json:"description" graphql:"description"`
        Kind          string    `json:"kind" graphql:"kind"`
        Configuration string    `json:"configuration" graphql:"configuration"`
        CreatedAt     time.Time `json:"createdAt" graphql:"createdAt"`
        UpdatedAt     time.Time `json:"updatedAt" graphql:"updatedAt"`
        DeletedAt     time.Time `json:"deletedAt" graphql:"deletedAt"`
}

type StoragePrototype struct {
        Id          uuid.UUID `json:"id" graphql:"id"`
        Name        string    `json:"name" graphql:"name"`
        Description string    `json:"description" graphql:"description"`
        Kind        string    `json:"kind" graphql:"kind"`
        CreatedAt   time.Time `json:"createdAt" graphql:"createdAt"`
        UpdatedAt   time.Time `json:"updatedAt" graphql:"updatedAt"`
        DeletedAt   time.Time `json:"deletedAt" graphql:"deletedAt"`
}

type StoragesPage struct {
        Rows []StoragePrototype `json:"rows" graphql:"rows"`
        Page
}

type GetStorageDto struct {
        Id uuid.UUID `json:"id" graphql:"id"`
}

func GetStorage(ctx context.Context, args GetStorageDto) (*Storage, error) <span class="cov8" title="1">{
        if !IsPermitted(ctx, []string{"storage.view"}) </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("missing permission")
        }</span>
        <span class="cov8" title="1">reactive.InvalidateAfter(ctx, 5*time.Second)
        storage, err := datasource.StorageProvider.GetStorage(args.Id)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>
        <span class="cov8" title="1">var storageDto *Storage
        dto.Map(&amp;storage, &amp;storageDto)

        return storageDto, nil</span>
}

func GetStorages(ctx context.Context, args PageArgs) (*StoragesPage, error) <span class="cov8" title="1">{
        if !IsPermitted(ctx, []string{"storage.view"}) </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("missing permission")
        }</span>
        <span class="cov8" title="1">reactive.InvalidateAfter(ctx, 5*time.Second)

        var pagination provider.Pagination[model.Storage]
        dto.Map(&amp;args, &amp;pagination)

        pages, err := datasource.StorageProvider.GetStoragesPaged(&amp;pagination)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>

        <span class="cov8" title="1">var pageDtos StoragesPage
        dto.Map(&amp;pages, &amp;pageDtos)

        return &amp;pageDtos, nil</span>
}

type CreateStorageDto struct {
        Name          string `json:"name" graphql:"name"`
        Description   string `json:"description" graphql:"description"`
        Kind          string `json:"kind" graphql:"kind"`
        Configuration string `json:"configuration" graphql:"configuration"`
}

func CreateStorage(ctx context.Context, args CreateStorageDto) (*Storage, error) <span class="cov8" title="1">{
        if !IsPermitted(ctx, []string{"storage.create"}) </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("missing permission")
        }</span>
        <span class="cov8" title="1">reactive.InvalidateAfter(ctx, 5*time.Second)
        storage, err := datasource.StorageProvider.CreateStorage(args.Name, args.Description, args.Kind, args.Configuration)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>
        <span class="cov8" title="1">var storageDto Storage
        dto.Map(storage, &amp;storageDto)

        return &amp;storageDto, err</span>
}

type UpdateStorageDto struct {
        Id            uuid.UUID `json:"id" graphql:"id"`
        Name          *string   `json:"name" graphql:"name"`
        Description   *string   `json:"description" graphql:"description"`
        Kind          *string   `json:"kind" graphql:"kind"`
        Configuration *string   `json:"configuration" graphql:"configuration"`
}

func UpdateStorage(ctx context.Context, args UpdateStorageDto) (*Storage, error) <span class="cov8" title="1">{
        if !IsPermitted(ctx, []string{"storage.update"}) </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("missing permission")
        }</span>
        <span class="cov8" title="1">reactive.InvalidateAfter(ctx, 5*time.Second)
        storage, err := datasource.StorageProvider.UpdateStorage(args.Id, args.Name, args.Description, args.Kind, args.Configuration)

        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>
        <span class="cov8" title="1">var storageDto Storage
        dto.Map(&amp;storage, &amp;storageDto)

        return &amp;storageDto, nil</span>
}

type DeleteStorageDto struct {
        Id uuid.UUID `json:"id" graphql:"id"`
}

func DeleteStorage(ctx context.Context, args DeleteStorageDto) (*Storage, error) <span class="cov8" title="1">{
        if !IsPermitted(ctx, []string{"storage.delete"}) </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("missing permission")
        }</span>
        <span class="cov8" title="1">storage, err := datasource.StorageProvider.DeleteStorage(args.Id)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>
        <span class="cov8" title="1">var storageDto Storage
        dto.Map(&amp;storage, &amp;storageDto)

        return &amp;storageDto, nil</span>
}

type StorageKindDescriptionDto struct {
        Name          string                               `json:"name" graphql:"name"`
        Configuration []StorageConfigurationDescriptionDto `json:"configuration" graphql:"configuration"`
}

type StorageConfigurationDescriptionDto struct {
        Name string `json:"name" graphql:"name"`
        Kind string `json:"kind" graphql:"kind"`
}

func GetStorageKinds() ([]StorageKindDescriptionDto, error) <span class="cov8" title="1">{
        var descriptions []StorageKindDescriptionDto
        for _, kind := range storage.Values() </span><span class="cov8" title="1">{
                var configurations []StorageConfigurationDescriptionDto

                val := reflect.ValueOf(kind.DefaultConfiguration()).Elem()
                for i := 0; i &lt; val.NumField(); i++ </span><span class="cov8" title="1">{
                        configurations = append(configurations, StorageConfigurationDescriptionDto{
                                Name: val.Type().Field(i).Tag.Get("json"),
                                Kind: val.Type().Field(i).Tag.Get("slixx"),
                        })
                }</span>

                <span class="cov8" title="1">descriptions = append(descriptions, StorageKindDescriptionDto{
                        Name:          kind.GetName(),
                        Configuration: configurations,
                })</span>
        }

        <span class="cov8" title="1">return descriptions, nil</span>
}
</pre>
		
		<pre class="file" id="file10" style="display: none">package controller

import (
        "context"
        "github.com/google/uuid"
        "github.com/samsarahq/thunder/graphql"
        "github.com/samsarahq/thunder/reactive"
        "kroseida.org/slixx/internal/master/application"
        "kroseida.org/slixx/internal/master/datasource"
        "kroseida.org/slixx/internal/master/datasource/provider"
        "kroseida.org/slixx/pkg/dto"
        "kroseida.org/slixx/pkg/model"
        "time"
)

type User struct {
        Id          uuid.UUID `json:"id" graphql:"id"`
        Name        string    `json:"name" graphql:"name"`
        FirstName   string    `json:"firstName" graphql:"firstName"`
        LastName    string    `json:"lastName" graphql:"lastName"`
        Email       string    `json:"email" graphql:"email"`
        Active      bool      `json:"active" graphql:"active"`
        Permissions string    `json:"permissions" graphql:"permissions"`
        Description string    `json:"description" graphql:"description"`
        CreatedAt   time.Time `json:"createdAt" graphql:"createdAt"`
        UpdatedAt   time.Time `json:"updatedAt" graphql:"updatedAt"`
        DeletedAt   time.Time `json:"deletedAt" graphql:"deletedAt"`
}

type UsersPage struct {
        Rows []User `json:"rows" graphql:"rows"`
        Page
}

type Authentication struct {
        Id        uuid.UUID `json:"id" graphql:"id"`
        UserId    uuid.UUID `json:"userId" graphql:"userId"`
        Kind      string    `json:"kind" graphql:"kind"`
        CreatedAt time.Time `json:"createdAt" graphql:"createdAt"`
        UpdatedAt time.Time `json:"updatedAt" graphql:"updatedAt"`
        DeletedAt time.Time `json:"deletedAt" graphql:"deletedAt"`
}

type Session struct {
        Id        uuid.UUID `json:"id" graphql:"id"`
        UserId    uuid.UUID `json:"userId" graphql:"userId"`
        ExpiresAt time.Time `json:"expiresAt" graphql:"expiresAt"`
        CreatedAt time.Time `json:"createdAt" graphql:"createdAt"`
        UpdatedAt time.Time `json:"updatedAt" graphql:"updatedAt"`
        DeletedAt time.Time `json:"deletedAt" graphql:"deletedAt"`
}

type ExposedSession struct {
        Id        uuid.UUID `json:"id" graphql:"id"`
        UserId    uuid.UUID `json:"userId" graphql:"userId"`
        ExpiresAt time.Time `json:"expiresAt" graphql:"expiresAt"`
        CreatedAt time.Time `json:"createdAt" graphql:"createdAt"`
        UpdatedAt time.Time `json:"updatedAt" graphql:"updatedAt"`
        DeletedAt time.Time `json:"deletedAt" graphql:"deletedAt"`
        Token     string    `json:"token" graphql:"token"`
}

type CreateUserDto struct {
        Name        string `json:"name" graphql:"name"`
        FirstName   string `json:"firstName" graphql:"firstName"`
        LastName    string `json:"lastName" graphql:"lastName"`
        Email       string `json:"email" graphql:"email"`
        Description string `json:"description" graphql:"description"`
        Active      bool   `json:"active" graphql:"active"`
}

func CreateUser(ctx context.Context, args CreateUserDto) (*User, error) <span class="cov8" title="1">{
        if !IsPermitted(ctx, []string{"user.create"}) </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("missing permission")
        }</span>
        <span class="cov8" title="1">reactive.InvalidateAfter(ctx, 5*time.Second)
        user, err := datasource.UserProvider.CreateUser(args.Name, args.Email, args.FirstName, args.LastName, args.Description, args.Active)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>
        <span class="cov8" title="1">var userDto User
        dto.Map(user, &amp;userDto)

        return &amp;userDto, nil</span>
}

type UpdateUserDto struct {
        Id          uuid.UUID `json:"id" graphql:"id"`
        Name        *string   `json:"name" graphql:"name"`
        FirstName   *string   `json:"firstName" graphql:"firstName"`
        LastName    *string   `json:"lastName" graphql:"lastName"`
        Active      *bool     `json:"active" graphql:"active"`
        Description *string   `json:"description" graphql:"description"`
        Email       *string   `json:"email" graphql:"email"`
}

func UpdateUser(ctx context.Context, args UpdateUserDto) (*User, error) <span class="cov0" title="0">{
        if !IsPermitted(ctx, []string{"user.update"}) </span><span class="cov0" title="0">{
                return nil, graphql.NewSafeError("missing permission")
        }</span>
        <span class="cov0" title="0">reactive.InvalidateAfter(ctx, 5*time.Second)
        user, err := datasource.UserProvider.UpdateUser(args.Id, args.Name, args.FirstName, args.LastName, args.Active, args.Description, args.Email)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>
        <span class="cov0" title="0">var userDto User
        dto.Map(&amp;user, &amp;userDto)

        return &amp;userDto, nil</span>
}

type AddUserPermissionDto struct {
        Id          uuid.UUID `json:"id" graphql:"id"`
        Permissions []string  `json:"permissions" graphql:"permissions"`
}

func AddUserPermission(ctx context.Context, args AddUserPermissionDto) (*User, error) <span class="cov8" title="1">{
        if !IsPermitted(ctx, []string{"user.permission.update"}) </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("missing permission")
        }</span>
        <span class="cov8" title="1">reactive.InvalidateAfter(ctx, 5*time.Second)
        user, err := datasource.UserProvider.AddUserPermission(args.Id, args.Permissions)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>

        <span class="cov8" title="1">var userDto User
        dto.Map(&amp;user, &amp;userDto)

        return &amp;userDto, nil</span>
}

type RemoveUserPermissionDto struct {
        Id          uuid.UUID `json:"id" graphql:"id"`
        Permissions []string  `json:"permissions" graphql:"permissions"`
}

func RemoveUserPermission(ctx context.Context, args RemoveUserPermissionDto) (*User, error) <span class="cov8" title="1">{
        if !IsPermitted(ctx, []string{"user.permission.update"}) </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("missing permission")
        }</span>
        <span class="cov8" title="1">reactive.InvalidateAfter(ctx, 5*time.Second)
        user, err := datasource.UserProvider.RemoveUserPermission(args.Id, args.Permissions)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>

        <span class="cov8" title="1">var userDto User
        dto.Map(&amp;user, &amp;userDto)

        return &amp;userDto, nil</span>
}

type UpdateUserPasswordDto struct {
        Id       uuid.UUID `json:"id" graphql:"id"`
        Password string    `json:"password" graphql:"password"`
}

func CreatePasswordAuthentication(ctx context.Context, args UpdateUserPasswordDto) (*Authentication, error) <span class="cov8" title="1">{
        if !IsPermitted(ctx, []string{"user.update"}) &amp;&amp; !IsSameUser(ctx, args.Id) </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("missing permission")
        }</span>
        <span class="cov8" title="1">reactive.InvalidateAfter(ctx, 5*time.Second)
        authentication, err := datasource.UserProvider.CreatePasswordAuthentication(args.Id, args.Password)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>
        <span class="cov8" title="1">var authenticationDto Authentication
        dto.Map(authentication, &amp;authenticationDto)

        return &amp;authenticationDto, nil</span>
}

type PasswordAuthenticationDto struct {
        Name     string `json:"name" graphql:"name"`
        Password string `json:"password" graphql:"password"`
}

func Authenticate(ctx context.Context, args PasswordAuthenticationDto) (*ExposedSession, error) <span class="cov8" title="1">{
        reactive.InvalidateAfter(ctx, 5*time.Second)
        session, err := datasource.UserProvider.AuthenticatePassword(args.Name, args.Password)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>
        <span class="cov8" title="1">var sessionDto ExposedSession
        dto.Map(session, &amp;sessionDto)

        return &amp;sessionDto, nil</span>
}

func GetUsers(ctx context.Context, args PageArgs) (*UsersPage, error) <span class="cov8" title="1">{
        if !IsPermitted(ctx, []string{"user.view"}) </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("missing permission")
        }</span>
        <span class="cov8" title="1">reactive.InvalidateAfter(ctx, 5*time.Second)

        var pagination provider.Pagination[model.User]
        dto.Map(&amp;args, &amp;pagination)

        users, err := datasource.UserProvider.GetUsersPaged(&amp;pagination)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>

        <span class="cov8" title="1">var userDtos UsersPage
        dto.Map(&amp;users, &amp;userDtos)

        return &amp;userDtos, nil</span>
}

type GetUserDto struct {
        Id uuid.UUID `json:"id" graphql:"id"`
}

func GetUser(ctx context.Context, args GetUserDto) (*User, error) <span class="cov8" title="1">{
        if !IsPermitted(ctx, []string{"user.view"}) &amp;&amp; !IsSameUser(ctx, args.Id) </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("missing permission")
        }</span>
        <span class="cov8" title="1">reactive.InvalidateAfter(ctx, 5*time.Second)
        user, err := datasource.UserProvider.GetUser(args.Id)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>
        <span class="cov8" title="1">var userDto *User
        dto.Map(&amp;user, &amp;userDto)

        return userDto, nil</span>
}

type DeleteUserDto struct {
        Id uuid.UUID `json:"id" graphql:"id"`
}

func DeleteUser(ctx context.Context, args DeleteUserDto) (*User, error) <span class="cov8" title="1">{
        if !IsPermitted(ctx, []string{"user.delete"}) </span><span class="cov8" title="1">{
                return nil, graphql.NewSafeError("missing permission")
        }</span>
        <span class="cov8" title="1">reactive.InvalidateAfter(ctx, 5*time.Second)
        user, err := datasource.UserProvider.DeleteUser(args.Id)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>
        <span class="cov8" title="1">var userDto User
        dto.Map(&amp;user, &amp;userDto)

        return &amp;userDto, nil</span>
}

func GetLocalUser(ctx context.Context) (*User, error) <span class="cov8" title="1">{
        reactive.InvalidateAfter(ctx, 5*time.Second)
        if ctx.Value("user").(*model.User) == nil </span><span class="cov0" title="0">{
                return nil, nil
        }</span>
        <span class="cov8" title="1">user, err := datasource.UserProvider.GetUser(ctx.Value("user").(*model.User).Id)
        if err != nil </span><span class="cov0" title="0">{
                application.Logger.Debug(err)
                return nil, err
        }</span>
        <span class="cov8" title="1">var userDto User
        dto.Map(&amp;user, &amp;userDto)

        return &amp;userDto, nil</span>
}

type PermissionDto struct {
        Value string `json:"value" graphql:"value"`
        Name  string `json:"name" graphql:"name"`
}

func GetPermissions() ([]PermissionDto, error) <span class="cov0" title="0">{
        permissionDtos := make([]PermissionDto, 0)
        for value, name := range provider.PERMISSIONS </span><span class="cov0" title="0">{
                permissionDtos = append(permissionDtos, PermissionDto{
                        Value: value,
                        Name:  name,
                })
        }</span>
        <span class="cov0" title="0">return permissionDtos, nil</span>
}
</pre>
		
		<pre class="file" id="file11" style="display: none">package controller

import (
        "context"
        "github.com/google/uuid"
        "kroseida.org/slixx/pkg/model"
)

func IsPermitted(ctx context.Context, permissions []string) bool <span class="cov8" title="1">{
        user := ctx.Value("user").(*model.User)
        if user == nil </span><span class="cov0" title="0">{
                return false
        }</span>
        <span class="cov8" title="1">permitted, err := user.IsPermitted(permissions)
        if err != nil </span><span class="cov0" title="0">{
                return false
        }</span>
        <span class="cov8" title="1">return permitted</span>
}

func IsSameUser(ctx context.Context, id uuid.UUID) bool <span class="cov8" title="1">{
        user := ctx.Value("user").(*model.User)
        if user == nil </span><span class="cov0" title="0">{
                return false
        }</span>
        <span class="cov8" title="1">return user.Id == id</span>
}
</pre>
		
		<pre class="file" id="file12" style="display: none">package dto

import (
        "encoding/json"
)

func Map(from interface{}, to interface{}) <span class="cov8" title="1">{
        data, err := json.Marshal(from)

        if err != nil </span><span class="cov0" title="0">{
                panic(err)</span>
        }
        <span class="cov8" title="1">err = json.Unmarshal(data, to)
        if err != nil </span><span class="cov0" title="0">{
                panic(err)</span>
        }
}
</pre>
		
		<pre class="file" id="file13" style="display: none">package model

import (
        "encoding/json"
        "github.com/google/uuid"
        "time"
)

type User struct {
        Id          uuid.UUID `sql:"default:uuid_generate_v4()",json:"id"`
        Name        string    `json:"name"`
        Email       string    `json:"email"`
        FirstName   string    `json:"firstName"`
        LastName    string    `json:"lastName"`
        Active      bool      `json:"active"`
        Description string    `json:"description"`
        Permissions string    `json:"permissions"`
        CreatedAt   time.Time `json:"createdAt"`
        UpdatedAt   time.Time `json:"updatedAt"`
}

type Authentication struct {
        Id            uuid.UUID `sql:"default:uuid_generate_v4()",json:"id"`
        Kind          string    `json:"kind"`
        Configuration string    `json:"-" graphql-secret:"true"`
        UserId        uuid.UUID `json:"userId"`
        CreatedAt     time.Time `json:"createdAt"`
        UpdatedAt     time.Time `json:"updatedAt"`
}

type Session struct {
        Id        uuid.UUID `sql:"default:uuid_generate_v4()",json:"id" graphql:"id"`
        UserId    uuid.UUID `json:"userId" graphql:"userId"`
        ExpiresAt time.Time `json:"expiresAt" graphql:"expiresAt"`
        CreatedAt time.Time `json:"createdAt" graphql:"createdAt"`
        Token     string    `json:"token" graphql:"token" graphql-secret:"true"`
}

func (u *User) GetActivePermissions() ([]string, error) <span class="cov8" title="1">{
        var activePermissions []string
        err := json.Unmarshal([]byte(u.Permissions), &amp;activePermissions)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">return activePermissions, nil</span>
}

func (u *User) IsPermitted(permission []string) (bool, error) <span class="cov8" title="1">{
        activePermissions, err := u.GetActivePermissions()
        if err != nil </span><span class="cov0" title="0">{
                return false, err
        }</span>
        <span class="cov8" title="1">for _, activePermission := range activePermissions </span><span class="cov8" title="1">{
                for _, permission := range permission </span><span class="cov8" title="1">{
                        if activePermission == permission </span><span class="cov8" title="1">{
                                return true, nil
                        }</span>
                }
        }
        <span class="cov0" title="0">return false, err</span>
}

func (u *User) AddPermission(permissions []string) error <span class="cov8" title="1">{
        activePermissions, err := u.GetActivePermissions()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov8" title="1">for _, permission := range permissions </span><span class="cov8" title="1">{
                activePermissions = append(activePermissions, permission)
        }</span>
        <span class="cov8" title="1">jsonData, err := json.Marshal(activePermissions)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov8" title="1">u.Permissions = string(jsonData)

        return nil</span>
}

func (u *User) RemovePermission(permissions []string) error <span class="cov8" title="1">{
        activePermissions, err := u.GetActivePermissions()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov8" title="1">for _, permission := range permissions </span><span class="cov8" title="1">{
                for _, activePermission := range activePermissions </span><span class="cov8" title="1">{
                        if activePermission == permission </span><span class="cov8" title="1">{
                                activePermissions = remove(activePermissions, permission)
                        }</span>
                }
        }
        <span class="cov8" title="1">jsonData, err := json.Marshal(activePermissions)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov8" title="1">u.Permissions = string(jsonData)
        return nil</span>
}

func remove(s []string, r string) []string <span class="cov8" title="1">{
        for i, v := range s </span><span class="cov8" title="1">{
                if v == r </span><span class="cov8" title="1">{
                        return append(s[:i], s[i+1:]...)
                }</span>
        }
        <span class="cov0" title="0">return s</span>
}
</pre>
		
		<pre class="file" id="file14" style="display: none">package utils

import "os"

func FileExists(fileName string) bool <span class="cov8" title="1">{
        info, err := os.Stat(fileName)
        if os.IsNotExist(err) </span><span class="cov8" title="1">{
                return false
        }</span>
        <span class="cov8" title="1">return !info.IsDir()</span>
}
</pre>
		
		<pre class="file" id="file15" style="display: none">package utils

import (
        "encoding/hex"
        "math/rand"
)

func GenerateSecureToken(length int) string <span class="cov8" title="1">{
        b := make([]byte, length)
        if _, err := rand.Read(b); err != nil </span><span class="cov0" title="0">{
                return ""
        }</span>
        <span class="cov8" title="1">return hex.EncodeToString(b)</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
